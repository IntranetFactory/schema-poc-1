# Schema Form Engine - Implementation Instructions

## Overview

The schema form engine provides dynamic form generation based on JSON Schema with AJV validation using the sem-schema vocabulary. Forms are built with TanStack Form and shadcn UI components.

## Architecture

### Form Components (`apps/frontend/src/components/form/`)

Each format/type has a dedicated form control component:

- **TextInput** - Basic text input (string type)
- **EmailInput** - Email input with validation (format: "email")
- **NumberInput** - Number/integer input
- **TextareaInput** - Multi-line text (format: "text") 
- **CheckboxInput** - Boolean checkbox
- **DateInput** - Date picker with calendar (format: "date")
- **HtmlEditor** - CodeMirror editor with HTML syntax highlighting (format: "html")
- **JsonEditor** - CodeMirror editor with JSON syntax highlighting (format: "json")

All components implement the `FormControlProps` interface for consistency:
```typescript
interface FormControlProps {
  name: string
  label?: string
  description?: string
  value: any
  error?: string
  required?: boolean
  disabled?: boolean
  onChange: (value: any) => void
  onBlur?: () => void
}
```

### SchemaForm Component

The `SchemaForm` component (`apps/frontend/src/components/form/SchemaForm.tsx`) is the main entry point:

- **Auto-generates forms** from JSON Schema
- **Maps schema types/formats** to appropriate controls
- **Generates default values** from schema `default` fields or infers by type
- **Validates fields individually** onBlur using AJV
- **Validates entire form** on submit
- Supports both sem-schema's field-level `required: true` and standard `required: ["field"]`

### Form Viewer Route

The `/form-viewer` route (`apps/frontend/src/routes/form-viewer.tsx`) provides a demo:
- Accepts schema URL as query parameter: `?schema=<url>`
- Fetches schema and renders form dynamically  
- Validates form on submit (no actual submission)
- Displays submitted data for verification

## Usage

```tsx
import { SchemaForm } from '@/components/form'

const schema = {
  type: 'object',
  properties: {
    name: { type: 'string', required: true, minLength: 1 },
    email: { type: 'string', format: 'email' },
    bio: { format: 'text' },
    config: { format: 'json' }
  },
  required: ['name', 'email']
}

<SchemaForm 
  schema={schema} 
  initialValue={data}
  onSubmit={(value) => console.log('Valid data:', value)} 
/>
```

## Validation

### Field-Level (onBlur)

Each field validates when it loses focus:
```typescript
validators={{
  onBlur: ({ value }) => validateField(value, propSchema, key, schema)
}}
```

### Form-Level (onSubmit)

The entire form validates on submit:
```typescript
const result = validateData(value, schema)
if (result.valid) {
  onSubmit?.(value)
} else {
  // Display errors on each field
}
```

Validation uses the sem-schema validator which extends AJV with:
- Custom formats: `json`, `html`, `text`
- Property-level `required` keyword (non-empty strings)
- Number `precision` keyword (0-4 decimal places)

## Styling

### Current State

The form components use shadcn UI components (Input, Label, Textarea, Checkbox, Button, DatePicker) with Tailwind CSS classes. However, there is a **known issue with Tailwind v4** where utility classes are not being generated correctly.

**Issue**: The HTML elements have the correct Tailwind classes applied (e.g., `border`, `rounded-md`, `px-3`, `py-2`), but the CSS for these classes is not being generated by Tailwind v4. This results in unstyled form fields without visible borders, padding, or other styling.

**Root Cause**: Tailwind v4's file scanning and CSS generation is not picking up the utility classes from the form component files, likely due to:
1. Tailwind v4 content scanning configuration
2. Dynamic component rendering patterns
3. Vite build/dev mode caching issues

### Required Fix

To properly style the forms with shadcn appearance:

1. **Verify Tailwind v4 Configuration**: Ensure `tailwind.config.js` or equivalent is properly configured to scan all component files, especially:
   ```javascript
   content: ['./src/**/*.{ts,tsx,js,jsx}']
   ```

2. **Check PostCSS Configuration**: Ensure PostCSS is correctly processing Tailwind directives

3. **Inspect Build Output**: Verify that utility classes are present in the generated CSS:
   ```bash
   grep "\.border\|\.px-3\|\.rounded-md" dist/assets/*.css
   ```

4. **Consider Workarounds**:
   - Use inline styles as fallback
   - Create custom CSS classes for common patterns
   - Migrate to Tailwind v3 if v4 issues persist
   - Use explicit style objects instead of utility classes

### Expected Visual Appearance

When properly styled with shadcn/Tailwind, forms should have:
- **Input fields**: Visible borders, rounded corners, padding, proper height
- **Labels**: Appropriate font size and spacing
- **Description text**: Muted color, smaller font
- **Error messages**: Red/destructive color
- **Spacing**: Consistent gaps between form fields (space-y-2, space-y-6)
- **Focus states**: Ring/outline on focused inputs
- **Disabled states**: Reduced opacity and cursor changes

## Testing

### Quality Standards

**CRITICAL**: All code changes MUST meet these quality standards before submission:

1. **Visual Verification Required**
   - ALWAYS use Playwright to visually verify UI changes
   - Take screenshots of BEFORE and AFTER states
   - Include screenshots in PR descriptions
   - Verify on actual running application, not just tests

2. **Form Validation Testing**
   - Test submit button with empty required fields
   - Verify error messages appear correctly
   - Test field-level validation (onBlur)
   - Test form-level validation (onSubmit)
   - Ensure validation errors are displayed to users

3. **Layout and Styling**
   - Verify no unwanted scrollbars appear on viewport
   - Ensure form areas scroll when content overflows
   - Check all inputs have proper borders and shadows
   - Verify date pickers and dropdowns render correctly
   - Test responsive behavior

4. **Test Coverage**
   - ALL new input controls MUST have tests
   - Tests must verify rendering, validation, and user interaction
   - Failing tests indicate failing functionality
   - Run full test suite before committing: `pnpm test`

### Manual Testing

1. Start dev server: `pnpm dev`
2. Navigate to: `http://localhost:5173/form-playground?schema=/schemas/all-formats.schema.json`
3. Verify:
   - No scrollbars on page viewport
   - Form area scrolls when content overflows
   - All field types render with proper styling
   - Field validation triggers onBlur
   - Form validation triggers on submit  
   - Error messages display correctly
   - CodeMirror editors work for HTML/JSON
   - Date picker has shadow/border
   - Date picker calendar displays correctly

### Automated Tests

All form components have comprehensive test coverage:
- **Unit tests** for each form control component (26 test files, 57 tests)
- **Integration tests** for SchemaForm (15 tests)
  - Field-level validation (onBlur)
  - Form-level validation (onSubmit)
  - Required field validation
  - Default value handling
  - Reset functionality
- **E2E tests** should be added for form-playground route

#### Running Tests

```bash
# Run all tests
pnpm test

# Run tests in watch mode during development  
pnpm test:watch

# Run tests for a specific component
pnpm test InputDate
```

#### Test Requirements for New Components

When adding new input controls, MUST include:

1. **Rendering Test**: Verify component renders correctly
2. **Styling Test**: Check proper CSS classes are applied
3. **Required Field Test**: Show asterisk when required
4. **Validation Test**: Accept validators prop
5. **Label/Description Test**: Display label and description
6. **User Interaction Test**: Test typing/interaction where applicable

Example test structure:
```typescript
describe('InputNewControl', () => {
  it('should render control with proper type', () => { ... })
  it('should have proper styling with border', () => { ... })
  it('should show required indicator when field is required', () => { ... })
  it('should support validation via validators prop', () => { ... })
  it('should display label and description', () => { ... })
  it('should accept user input', () => { ... })
})
```

## Known Limitations

1. **Tailwind v4 Styling Issue**: Utility classes not generating CSS (see Styling section)
2. **No array/object field support**: Only primitive types and string formats supported
3. **Limited validation feedback**: Only shows first error per field
4. **No field dependencies**: Can't conditionally show/hide fields based on other values
5. **No custom validation rules**: Only schema-based validation supported

## Future Enhancements

1. **Fix Tailwind v4 styling** - Top priority
2. **Add array field support** - For list inputs
3. **Add nested object support** - For complex forms  
4. **Conditional fields** - Show/hide based on values
5. **Custom validators** - Beyond schema validation
6. **Field groups/sections** - Better organization
7. **Inline error display** - More intuitive UX
8. **Loading states** - For async operations
9. **Autosave** - Draft saving functionality
10. **Accessibility improvements** - ARIA labels, keyboard navigation
